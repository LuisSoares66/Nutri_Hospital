{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2 style="margin-top:0;">Produtos — {{ hospital.nome_hospital or "Hospital (sem nome)" }}</h2>
  <div class="muted" style="font-size:16px;">
    {{ (hospital.cidade or "") ~ "/" ~ (hospital.estado or "") }}
  </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="card">
      {% for category, message in messages %}
        <div style="margin:6px 0; font-size:16px;">
          {% if category == "error" %}
            <span style="color:#c0392b;"><b>Erro:</b> {{ message }}</span>
          {% else %}
            <span style="color:#2c7;"><b>OK:</b> {{ message }}</span>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="card">
  <h3 style="margin-top:0;">Adicionar produto</h3>

  <form method="POST">
    <label style="font-size:16px;"><b>Produto</b></label>
    <select name="produto_id" required style="font-size:16px;">
      <option value="">Selecione</option>
      {% for p in produtos %}
        <option value="{{p.id}}">{{p.nome}}</option>
      {% endfor %}
    </select>

    <label style="font-size:16px; margin-top:10px;"><b>Quantidade</b></label>
    <input name="quantidade" type="number" min="1" value="1" required style="font-size:16px;">

    <div class="btns" style="margin-top:12px;">
      <button class="btn" type="submit">Salvar</button>
      <a class="btn secondary" href="/hospital/{{hospital.id}}">Voltar</a>
      <a class="btn secondary" href="/leitura">Leitura</a>
    </div>
  </form>
</div>

<div class="card">
  <h3 style="margin-top:0;">Produtos lançados</h3>

  {% if itens|length == 0 %}
    <p class="muted">Nenhum produto lançado para este hospital ainda.</p>
  {% else %}

    <div class="card" style="margin-bottom:12px;">
      <label for="buscaItens" style="font-size:16px;"><b>Buscar</b> (filtra na lista)</label>
      <input id="buscaItens" type="text" placeholder="Digite para filtrar..." style="font-size:16px;">
      <div class="muted" id="contadorItens" style="margin-top:6px;"></div>
    </div>

    <div class="table-wrap">
      <table id="tabelaItens" class="data-table">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Quantidade</th>
            <th>Adicionado em</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody>
          {% for item in itens %}
            <tr class="data-row">
              <td class="wrap">{{ item.produto.nome }}</td>
              <td class="nowrap">{{ item.quantidade }}</td>
              <td class="nowrap">{{ item.created_at }}</td>
              <td class="nowrap">
                <form method="POST"
                      action="/hospital/{{hospital.id}}/produtos/{{item.id}}/remover"
                      onsubmit="return confirm('Remover este item?');"
                      style="display:inline;">
                  <button class="btn" type="submit"
                          style="padding:6px 10px; font-size:14px; background:#c0392b;">
                    Remover
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <style>
      .table-wrap{
        border:1px solid #ddd;
        border-radius:10px;
        overflow:auto;
        background:#fff;
        max-height: 60vh;
      }
      .data-table{
        border-collapse:collapse;
        width:100%;
      }
      .data-table th, .data-table td{
        border:1px solid #ddd;
        padding:8px;
        vertical-align:top;
        font-size:16px;
      }
      .data-table thead th{
        position: sticky;
        top: 0;
        z-index: 2;
        background:#f3f3f3;
      }
      .nowrap{ white-space:nowrap; }
      .wrap{ white-space:pre-wrap; word-break:break-word; }
      .hidden-row{ display:none; }
    </style>

    <script>
      (function(){
        const input = document.getElementById("buscaItens");
        const rows = Array.from(document.querySelectorAll("#tabelaItens tbody tr"));
        const contador = document.getElementById("contadorItens");

        function normalize(s){
          return (s || "").toString().toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function atualizarContador(visiveis){
          contador.textContent = `${visiveis} de ${rows.length} item(ns) exibido(s).`;
        }

        function filtrar(){
          const q = normalize(input.value.trim());
          let vis = 0;
          rows.forEach(tr => {
            const text = normalize(tr.innerText);
            const ok = q === "" || text.includes(q);
            tr.classList.toggle("hidden-row", !ok);
            if(ok) vis++;
          });
          atualizarContador(vis);
        }

        input.addEventListener("input", filtrar);
        atualizarContador(rows.length);
      })();
    </script>
  {% endif %}
</div>

{% endblock %}
