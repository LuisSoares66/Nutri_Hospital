{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <h2>{{ hospital.nome_hospital }} - Produtos</h2>

  {% include "_hospital_tabs.html" %}

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card shadow-sm mb-4">
    <div class="card-body">

      <form method="POST" action="{{ url_for('main.produtos_hospital', hospital_id=hospital.id) }}">
        <input type="hidden" name="produto_id" value="">

        <div class="row g-3">
          <!-- MARCA (rolagem) -->
          <div class="col-md-4">
            <label class="form-label">Marca (Catálogo)</label>
            <select id="marca_select" class="form-select" size="10">
              {% for m in marcas_catalogo %}
                <option value="{{ m }}">{{ m }}</option>
              {% endfor %}
            </select>
            <small class="text-muted">Clique em uma marca para carregar os produtos.</small>

            <!-- campo REAL enviado no POST -->
            <input type="hidden" name="marca_planilha" id="marca_planilha" value="">
          </div>

          <!-- PRODUTO (rolagem) -->
          <div class="col-md-5">
            <label class="form-label">Produto (Catálogo)</label>
            <select id="produto_select" class="form-select" size="10">
              <option value="" disabled>Selecione uma marca…</option>
            </select>
            <small class="text-muted">Clique no produto para preencher o campo abaixo.</small>
          </div>

          <!-- CAMPOS DO FORM -->
          <div class="col-md-3">
            <label class="form-label">Produto selecionado</label>
            <input type="text" class="form-control" name="produto" id="produto_input" required>

            <label class="form-label mt-2">Quantidade</label>
            <input type="number" class="form-control" name="quantidade" value="1" min="0">

            <button class="btn btn-success w-100 mt-3" type="submit">
              Salvar
            </button>
          </div>
        </div>
      </form>

    </div>
  </div>

  <!-- LISTA SALVA NO HOSPITAL -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="mb-3">Produtos cadastrados</h5>

      <table class="table table-sm table-hover align-middle">
        <thead>
          <tr>
            <th>Marca</th>
            <th>Produto</th>
            <th>Qtd</th>
          </tr>
        </thead>
        <tbody>
          {% for p in produtos %}
          <tr>
            <td>{{ p.marca_planilha }}</td>
            <td>{{ p.produto }}</td>
            <td>{{ p.quantidade }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if not produtos %}
        <p class="text-muted mb-0">Nenhum produto cadastrado.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  const marcaSelect = document.getElementById("marca_select");
  const produtoSelect = document.getElementById("produto_select");
  const produtoInput = document.getElementById("produto_input");
  const marcaHidden = document.getElementById("marca_planilha");

  async function carregarProdutosDaMarca(marca) {
    produtoSelect.innerHTML = `<option value="" disabled>Carregando…</option>`;
    const resp = await fetch(`/api/catalogo_produtos?marca=${encodeURIComponent(marca)}`);
    const data = await resp.json();

    produtoSelect.innerHTML = "";
    if (!data.produtos || data.produtos.length === 0) {
      produtoSelect.innerHTML = `<option value="" disabled>Nenhum produto nessa marca</option>`;
      return;
    }

    for (const p of data.produtos) {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      produtoSelect.appendChild(opt);
    }
  }

  marcaSelect.addEventListener("change", (e) => {
    const marca = e.target.value || "";
    marcaHidden.value = marca; // envia no POST
    produtoInput.value = "";   // limpa
    carregarProdutosDaMarca(marca);
  });

  produtoSelect.addEventListener("change", (e) => {
    const prod = e.target.value || "";
    produtoInput.value = prod; // preenche input
  });
</script>

{% endblock %}
