{% extends "base.html" %}
{% block content %}
  <h2>Relatórios - Hospitais</h2>

  <div class="card">
    <div><b>Total de hospitais:</b> {{total}}</div>
    <div><b>Média de leitos:</b> {{ "%.2f"|format(media_leitos or 0) }}</div>
    <div><b>Média de leitos UTI:</b> {{ "%.2f"|format(media_uti or 0) }}</div>
  </div>

  <div class="card">
    <h3>Top especialidades (até 5)</h3>
    {% if top_especialidades|length == 0 %}
      <div class="muted">Sem dados ainda.</div>
    {% endif %}
    {% for esp, qtd in top_especialidades %}
      <div>• {{esp}} — {{qtd}}</div>
    {% endfor %}
  </div>

  <div class="card">
    <h3>Registros (tabela + filtros)</h3>

    <!-- Barra de busca + filtro por coluna + botões -->
    <div class="card" style="margin-bottom:12px;">
      <div style="display:grid; grid-template-columns: 2fr 1fr; gap: 12px;">
        <div>
          <label for="buscaRel"><b>Buscar</b></label>
          <input id="buscaRel" type="text" placeholder="Digite para filtrar... (ex: hospital x, cidade, ONA, bionexo)" />
        </div>

        <div>
          <label for="colunaRel"><b>Filtrar por coluna</b></label>
          <select id="colunaRel">
            <option value="all">Todas</option>

            <!-- índices = posição do TD (0..n) -->
            <option value="2">Nome do hospital</option>
            <option value="3">Cidade</option>
            <option value="4">UF</option>
            <option value="5">Telefone</option>

            <option value="6">Especialidade</option>
            <option value="9">Certificações</option>
            <option value="10">Fatores decisórios</option>
            <option value="11">Prioridades</option>

            <option value="12">Convênio</option>
            <option value="13">Modelo compras</option>
            <option value="14">Contrato</option>
            <option value="15">Nova negociação</option>
          </select>
        </div>
      </div>

      <div class="btns" style="margin-top:10px;">
        <button id="btnLimpar" type="button" class="btn secondary">Limpar busca</button>
        <button id="btnCSV" type="button" class="btn light">Exportar CSV (filtrado)</button>
        <a class="btn" href="/relatorios/pdf">Baixar PDF</a>
        <a class="btn secondary" href="{{ url_for('main.hospitais') }}">⬅ Voltar</a>
      </div>

      <div class="muted" id="contadorRel" style="margin-top:8px;"></div>
    </div>

    {% if hospitais|length == 0 %}
      <p class="muted">Nenhum registro cadastrado.</p>
    {% else %}

      <div class="table-wrap">
        <table id="tabelaRel" class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Criado em</th>

              <th>Nome do hospital</th>
              <th>Cidade</th>
              <th>UF</th>
              <th>Telefone</th>

              <th>Especialidade</th>
              <th>Leitos</th>
              <th>UTI</th>

              <th>Certificações</th>
              <th>Fatores decisórios</th>
              <th>Prioridades</th>

              <th>Convênio</th>
              <th>Modelo compras</th>
              <th>Contrato</th>
              <th>Nova negociação</th>
            </tr>
          </thead>

          <tbody>
            {% for h in hospitais %}
              <tr class="data-row">
                <td class="nowrap">{{h.id}}</td>
                <td class="nowrap">{{h.created_at}}</td>

                <td class="wrap"><b>{{h.nome_hospital}}</b></td>
                <td class="nowrap">{{h.cidade}}</td>
                <td class="nowrap">{{h.estado}}</td>
                <td class="nowrap">{{h.telefone}}</td>

                <td class="wrap">{{h.especialidade}}</td>
                <td class="nowrap">{{h.leitos}}</td>
                <td class="nowrap">{{h.leitos_uti}}</td>

                <td class="wrap">{{h.certificacoes}}</td>
                <td class="wrap">{{h.fatores_decisorios}}</td>
                <td class="wrap">{{h.prioridades_excelencia}}</td>

                <td class="nowrap">{{h.tem_convenio}}</td>
                <td class="wrap">{{h.modelo_compras}}</td>
                <td class="nowrap">{{h.contrato_periodicidade}}</td>
                <td class="wrap">{{h.nova_negociacao_quando}}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <style>
        .table-wrap{
          border:1px solid #ddd;
          border-radius:10px;
          overflow:auto;
          max-height: 70vh;
          background:#fff;
        }
        .data-table{
          border-collapse:collapse;
          width:100%;
          min-width: 1800px;
        }
        .data-table th, .data-table td{
          border:1px solid #ddd;
          padding:8px;
          vertical-align:top;
          font-size:16px;
        }
        .data-table thead th{
          position: sticky;
          top: 0;
          z-index: 2;
          background:#f3f3f3;
        }
        .nowrap{ white-space:nowrap; }
        .wrap{ white-space:pre-wrap; word-break:break-word; }
        .hidden-row{ display:none; }
      </style>

      <script>
        (function(){
          const input = document.getElementById("buscaRel");
          const selectCol = document.getElementById("colunaRel");
          const rows = Array.from(document.querySelectorAll("#tabelaRel tbody tr"));
          const contador = document.getElementById("contadorRel");
          const btnLimpar = document.getElementById("btnLimpar");
          const btnCSV = document.getElementById("btnCSV");

          function normalize(s){
            return (s || "").toString().toLowerCase()
              .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
          }

          function getRowTextByColumn(tr, colIndex){
            const tds = tr.querySelectorAll("td");
            if(colIndex < 0 || colIndex >= tds.length) return "";
            return tds[colIndex].innerText || "";
          }

          function atualizarContador(visiveis){
            contador.textContent = `${visiveis} de ${rows.length} registro(s) exibido(s).`;
          }

          function filtrar(){
            const q = normalize(input.value.trim());
            const col = selectCol.value;

            let vis = 0;
            rows.forEach(tr => {
              let text = (col === "all") ? tr.innerText : getRowTextByColumn(tr, parseInt(col, 10));
              const ok = (q === "") || normalize(text).includes(q);
              tr.classList.toggle("hidden-row", !ok);
              if(ok) vis++;
            });

            atualizarContador(vis);
          }

          function limpar(){
            input.value = "";
            selectCol.value = "all";
            filtrar();
            input.focus();
          }

          function download(filename, text){
            const blob = new Blob([text], {type: "text/csv;charset=utf-8;"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }

          function csvEscape(value){
            const s = (value ?? "").toString().replace(/\r?\n/g, " ");
            if(s.includes('"') || s.includes(";")){
              return `"${s.replace(/"/g, '""')}"`;
            }
            return s;
          }

          function exportarCSV(){
            const table = document.getElementById("tabelaRel");
            const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.innerText.trim());

            const visibleRows = rows.filter(tr => !tr.classList.contains("hidden-row"));
            const linhas = [];
            linhas.push(headers.map(csvEscape).join(";"));

            visibleRows.forEach(tr => {
              const cols = Array.from(tr.querySelectorAll("td")).map(td => td.innerText.trim());
              linhas.push(cols.map(csvEscape).join(";"));
            });

            download("relatorio_hospitais_filtrado.csv", linhas.join("\n"));
          }

          input.addEventListener("input", filtrar);
          selectCol.addEventListener("change", filtrar);
          btnLimpar.addEventListener("click", limpar);
          btnCSV.addEventListener("click", exportarCSV);

          atualizarContador(rows.length);
        })();
      </script>

    {% endif %}
  </div>

  <div class="btns">
    <a class="btn secondary" href="/">Voltar</a>
  </div>
{% endblock %}
